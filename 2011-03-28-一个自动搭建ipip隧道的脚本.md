date: 2011-03-28 08:08:08 +0800
update: ""
author: me
topic: ""
draft: false
top: false
title: 一个自动搭建ipip隧道的脚本
date: 2011-03-28 14:08:37 +0800
categories:
- scripts
tags:
- ipip
- linux
- route
- scripts
- tunnel
status: publish
type: post
published: true
---
<p>场景是这样的，两台机器A和B，通过缺省路由互相可达；希望A通过B的连接出去；A的地址为动态分配，且A可能的interface不缺定，因此，上来先给点先决条件：</p>

<p>&nbsp;</p>

<blockquote><p>#!/bin/bash</p>

<p>&nbsp;</p>

<p>default_dev="wlan0"</p>

<p>default_gw="192.168.12.1"</p>

<p>flag_nogw="false"</p>

<p>&nbsp;</p>

<p>local_ip=192.168.12.111</p>

<p>thost_ip=192.168.32.214</p>

<p>tnet_cidr="192.168.32.0/21"</p>

<p>&nbsp;</p>

<p>local_tun_addr="172.16.1.1"</p>

<p>remote_tun_addr="172.16.1.254"</p>

<p>tun_dev="tun9"</p>

<p>tun_cidr="172.16.0.0/16"</p>

<p>&nbsp;</p>

</blockquote>

<p>然后，想办法获取缺省路由的接口和网关地址，当然，不一定所有的缺省路由都有网关地址</p>

<p>&nbsp;</p>

<blockquote><p># get default gw and local ip address&nbsp;</p>

<p>route -n | while read dst gw msk flag metric ref use iface</p>

<p>do&nbsp;</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; if [ "$dst" = "0.0.0.0" -a "$msk" = "0.0.0.0" ]</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; then &nbsp; &nbsp;</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default_dev=$iface</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if [ "$flag" = "UG" ]</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; then &nbsp; &nbsp;</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default_gw=$gw</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else &nbsp; &nbsp;</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flag_nogw="true"</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi &nbsp; &nbsp; &nbsp;</p>

<p>&nbsp; &nbsp; &nbsp; &nbsp; fi &nbsp; &nbsp; &nbsp;</p>

<p>done</p>

</blockquote>

<div>之后判断一下连在缺省接口上的IP地址</div>

<div>

<blockquote>

<div>local_ip=$(ifconfig $default_dev | grep "inet addr"|sed -ne 's/.*inet addr:\([.0-9]\+\).*/\1/p')</div>

</blockquote>

</div>

<div>然后在远程主机上启动隧道、配置路由，并设置NAT：</div>

<div>

<blockquote>

<div>ssh ${thost_ip} iptunnel add ${tun_dev} mode ipip remote $local_ip local ${thost_ip}</div>

<div>ssh ${thost_ip} ifconfig ${tun_dev} ${remote_tun_addr}</div>

<div>ssh ${thost_ip} route add -net ${tun_cidr} dev ${tun_dev}</div>

<div>ssh ${thost_ip} iptables -t nat -A POSTROUTING -s ${local_tun_addr} -j MASQUERADE</div>

</blockquote>

</div>

<div>接下来设置本机上的隧道和路由：</div>

<div>

<blockquote>

<div>#setup tunnel on local machine</div>

<div>iptunnel add ${tun_dev} mode ipip remote ${thost_ip} local ${local_ip}</div>

<div>ifconfig ${tun_dev} ${local_tun_addr}</div>

<div>route add -net ${tun_cidr} dev ${tun_dev}</div>

</blockquote>

</div>

<div>最后，改缺省路由</div>

<div>

<blockquote>

<div>#setup default route rule</div>

<div>if [ "${flag_nogw}" = "false" ]</div>

<div>then</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; route add -net ${tnet_cidr} gw ${default_gw}</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; route del default gw ${default_gw}</div>

<div>else</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; route add -net ${tnet_cidr} dev ${default_dev}</div>

<div>&nbsp; &nbsp; &nbsp; &nbsp; route del default dev ${default_dev}</div>

<div>fi</div>

<div>route add default gw ${remote_tun_addr}</div>

</blockquote>

</div>

<div>完毕。</div>
