---
layout: post
title: CentOS/RHEL 5.4 BCM5709网卡问题
date: 2010-12-13 11:47:22.000000000 +08:00
categories:
- linux
tags:
- bcm5709
- bnx2
- bug
- centos
- disable_msi
- linux
- msi-x
- rhel
status: publish
type: post
published: true
meta:
  _edit_last: '1'
author:
  login: gnawux
  email: gnawux@gmail.com
  display_name: gnawux
  first_name: ''
  last_name: ''
---
<p>前不久我们的一批使用 Broadcom NetXtreme II BCM5709 千兆网卡的 CentOS 5.4 机器的网卡在大负载下频频挂掉，无法ping通任何其他机器，但可以ping通自己，只要重启网卡即可恢复，实在让人费解。</p>
<p>Google了一下，发现此版本的 bnx2 驱动缺省使用了 MSI-X，但在处理中断时可能会出现问题，具体影响的版本如下：</p>
<blockquote><p># uname -r<br />
2.6.18-164.6.1.el5<br />
# modinfo bnx2 |grep "^version"<br />
version:        1.9.3</p></blockquote>
<p>Red Hat的KB/Bugzilla里是这么记录的</p>
<blockquote><p>in certain circumstances, under heavy load, certain network interface cards using the bnx2 driver and configured to use MSI-X, could stop processing interrupts and then network connectivity would cease. (BZ#587799)</p></blockquote>
<p>嗯，解决方法，很简单，在/etc/modprobe.d/目录中添加一个文件，比如叫bnx2，设置一下模块参数：</p>
<blockquote><p># cat /etc/modprobe.d/bnx2<br />
# This is believed could solve the network freezing problem<br />
# RHKB: in certain circumstances, under heavy load, certain<br />
# network interface cards using the bnx2 driver and configured<br />
# to use MSI-X, could stop processing interrupts and then<br />
# network connectivity would cease. (BZ#587799)</p>
<p>options bnx2 disable_msi=1</p></blockquote>
<p>如果不重启机器的话，就重启一下模块</p>
<blockquote><p># modprobe –r bnx2<br />
# modprobe bnx2</p></blockquote>
<p>然后就OK了。</p>
