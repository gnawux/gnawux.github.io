---
layout: post
title: 用expect进行iLO远程配置
date: 2008-10-16 21:04:00.000000000 +08:00
categories:
- scripts
tags:
- expect
- iLO
- scripts
- ssh
status: publish
type: post
published: true
meta: {}
author:
  login: gnawux
  email: gnawux@gmail.com
  display_name: gnawux
  first_name: ''
  last_name: ''
---
<p>这里是脚本，用途是用 SSH 访问一组指定 ip 的 ilo，执行指定的一组命令，这个例子里是重新设置 IP</p>
<p>#!/usr/bin/expect   <br />set hostfile&#160;&#160;&#160;&#160; [open [lindex $argv 0] ]    <br />set cmdfile&#160;&#160;&#160;&#160; [open [lindex $argv 1] ]    <br />set prompt&#160;&#160;&#160;&#160; &quot;.*iLO-&gt;\ &quot;    <br />set passprompt&#160;&#160;&#160;&#160; &quot;.*password:\ &quot;    <br />set rejprompt&#160;&#160;&#160;&#160; &quot;.*refused&quot;    <br />set password&#160;&#160;&#160; &quot;mypasswd\r&quot;    <br />set timeout&#160;&#160;&#160; 20    <br />set origprefix 192.168.1.    <br />set newprefix 192.168.39.    <br />while {[gets $hostfile h] &gt;0} {    <br />&#160;&#160;&#160; seek $cmdfile 0    <br />&#160;&#160;&#160; spawn ssh $origprefix$h    <br />&#160;&#160;&#160; for {} {1} {} {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; expect {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;$rejprompt&quot; { puts &quot;refused&quot;;break }    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;$passprompt&quot; { send &quot;$password&quot; }    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;$prompt&quot; {     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; while { [gets $cmdfile c] &gt; 0 } {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; send &quot;$c\r&quot; ;     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }     <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; send &quot;set SubnetMask=255.255.248.0 IPv4Address=$newprefix$h\r&quot;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; expect $prompt    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; break    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; timeout {puts &quot;timeout&quot;; break}    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160; }    <br />}    <br />close $hostfile    <br />close $cmdfile</p>
<p>这个脚本接受两个参数，ip尾号列表文件，如下：</p>
<p>85   <br />86    <br />87    <br />88    <br />89    <br />90    <br />91</p>
<p>和 iLO 命令列表文件：</p>
<p>cd map1   <br />cd enetport1    <br />cd lanendpt1    <br />cd ipendpt1</p>
<p>这个脚本有一点特别之处——最后一个操作是设置 IP 地址，设置生效之后 SSH 连接就会自动断开，因此没有 close。</p>
